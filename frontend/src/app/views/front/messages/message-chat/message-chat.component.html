<div class="flex flex-col h-full futuristic-chat-container">
  <!-- Aucun conteneur spécial n'est nécessaire ici, car nous créons le modal dynamiquement -->
  <!-- En-tête futuriste -->
  <div class="futuristic-chat-header">
    <button (click)="goBackToConversations()" class="futuristic-action-button">
      <i class="fas fa-arrow-left"></i>
    </button>

    <div class="futuristic-user-info">
      <div class="futuristic-avatar">
        <img
          [src]="otherParticipant?.image || 'assets/images/default-avatar.png'"
          alt="User avatar"
        />
        <span
          *ngIf="otherParticipant?.isOnline"
          class="futuristic-online-indicator"
        ></span>
      </div>

      <!-- Nom et statut futuriste -->
      <div *ngIf="otherParticipant" class="futuristic-user-details">
        <span class="futuristic-username">
          {{ otherParticipant.username }}
        </span>
        <span class="futuristic-status">
          <i
            *ngIf="otherParticipant?.isOnline"
            class="fas fa-circle text-xs"
          ></i>
          {{
            otherParticipant.isOnline
              ? "Active now"
              : formatLastActive(otherParticipant.lastActive)
          }}
        </span>
      </div>
    </div>

    <div class="futuristic-actions">
      <button class="futuristic-action-button">
        <i class="fas fa-phone"></i>
      </button>
      <button class="futuristic-action-button">
        <i class="fas fa-video"></i>
      </button>
      <button class="futuristic-action-button">
        <i class="fas fa-info-circle"></i>
      </button>
    </div>
  </div>

  <!-- Zone de messages futuriste -->
  <div
    #messagesContainer
    class="futuristic-messages-container"
    (scroll)="onScroll($event)"
  >
    <!-- État de chargement (initial) -->
    <div *ngIf="loading" class="flex justify-center items-center h-full">
      <div class="futuristic-loading">
        <div class="futuristic-loading-circle"></div>
        <div class="futuristic-loading-text">Initializing communication...</div>
      </div>
    </div>

    <!-- Indicateur de chargement de messages supplémentaires -->
    <div
      *ngIf="isLoadingMore"
      class="flex justify-center py-2 sticky top-0 z-10"
    >
      <div class="futuristic-loading-more">
        <div class="futuristic-loading-dots">
          <div class="futuristic-loading-dot"></div>
          <div
            class="futuristic-loading-dot"
            style="animation-delay: 0.2s"
          ></div>
          <div
            class="futuristic-loading-dot"
            style="animation-delay: 0.4s"
          ></div>
        </div>
        <div class="futuristic-loading-text">Retrieving data...</div>
      </div>
    </div>

    <!-- Indicateur de début de conversation -->
    <div
      *ngIf="!hasMoreMessages && messages.length > 0"
      class="flex justify-center py-2 mb-2"
    >
      <div class="futuristic-conversation-start">
        <div class="futuristic-conversation-start-line"></div>
        <div class="futuristic-conversation-start-text">
          Communication Initialized
        </div>
        <div class="futuristic-conversation-start-line"></div>
      </div>
    </div>

    <!-- État d'erreur -->
    <div *ngIf="error" class="futuristic-error-container">
      <div class="futuristic-error-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="futuristic-error-content">
        <h3 class="futuristic-error-title">
          System Error: Communication Failure
        </h3>
        <p class="futuristic-error-message">{{ error }}</p>
      </div>
    </div>

    <!-- Messages -->
    <ng-container *ngIf="messages && messages.length > 0; else noMessages">
      <div
        *ngFor="let message of messages; let i = index"
        class="futuristic-message-wrapper"
        [attr.data-message-id]="message.id"
      >
        <!-- Séparateur de date futuriste -->
        <div *ngIf="shouldShowDateHeader(i)" class="futuristic-date-separator">
          <div class="futuristic-date-line"></div>
          <div class="futuristic-date-text">
            {{ formatMessageDate(message?.timestamp) }}
          </div>
          <div class="futuristic-date-line"></div>
        </div>

        <!-- Conteneur de message avec alignement -->
        <div
          class="futuristic-message"
          [ngClass]="{
            'futuristic-message-current-user':
              message?.sender?.id === currentUserId ||
              message?.sender?._id === currentUserId ||
              message?.senderId === currentUserId,
            'futuristic-message-other-user': !(
              message?.sender?.id === currentUserId ||
              message?.sender?._id === currentUserId ||
              message?.senderId === currentUserId
            )
          }"
        >
          <!-- Avatar pour les messages reçus -->
          <div
            *ngIf="
              !(
                message?.sender?.id === currentUserId ||
                message?.sender?._id === currentUserId ||
                message?.senderId === currentUserId
              )
            "
            class="futuristic-avatar"
          >
            <img
              [src]="
                message?.sender?.image || 'assets/images/default-avatar.png'
              "
              alt="User avatar"
              onerror="this.src='assets/images/default-avatar.png'"
            />
          </div>

          <!-- Contenu du message -->
          <div class="futuristic-message-content">
            <!-- Contenu textuel -->
            <div
              *ngIf="
                message?.content &&
                !hasImage(message) &&
                !isVoiceMessage(message)
              "
              class="futuristic-message-bubble"
              [ngClass]="{
                'futuristic-message-pending': message.isPending,
                'futuristic-message-sending':
                  message.isPending && !message.isError,
                'futuristic-message-error': message.isError
              }"
            >
              <div class="futuristic-message-text">
                {{ message.content }}
              </div>

              <!-- Heure du message avec statut de lecture -->
              <div class="futuristic-message-info">
                <span class="futuristic-message-time">
                  {{ formatMessageTime(message?.timestamp) }}
                </span>
                <span
                  *ngIf="
                    message?.sender?.id === currentUserId ||
                    message?.sender?._id === currentUserId ||
                    message?.senderId === currentUserId
                  "
                  class="futuristic-message-status"
                >
                  <i *ngIf="message?.isRead" class="fas fa-check-double"></i>
                  <i *ngIf="!message?.isRead" class="fas fa-check"></i>
                </span>
              </div>
            </div>

            <!-- Message vocal -->
            <div
              *ngIf="isVoiceMessage(message)"
              class="futuristic-message-bubble futuristic-voice-message-container"
              [ngClass]="{
                'futuristic-message-pending': message.isPending,
                'futuristic-message-sending':
                  message.isPending && !message.isError,
                'futuristic-message-error': message.isError
              }"
            >
              <div class="futuristic-voice-message">
                <div class="futuristic-voice-play-button">
                  <i class="fas fa-play"></i>
                </div>
                <div class="futuristic-voice-waveform">
                  <div
                    *ngFor="
                      let i of [
                        0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14
                      ]
                    "
                    class="futuristic-voice-bar"
                    [style.height.px]="
                      5 + (i % 3 === 0 ? 20 : i % 3 === 1 ? 15 : 10)
                    "
                  ></div>
                </div>
              </div>

              <app-voice-message-player
                [audioUrl]="getVoiceMessageUrl(message)"
                [duration]="getVoiceMessageDuration(message)"
                class="messenger-style-voice-message"
                style="display: none"
              ></app-voice-message-player>

              <!-- Heure du message avec statut de lecture -->
              <div class="futuristic-message-info">
                <span class="futuristic-message-time">
                  {{ formatMessageTime(message?.timestamp) }}
                </span>
                <span
                  *ngIf="
                    message?.sender?.id === currentUserId ||
                    message?.sender?._id === currentUserId ||
                    message?.senderId === currentUserId
                  "
                  class="futuristic-message-status"
                >
                  <i *ngIf="message?.isRead" class="fas fa-check-double"></i>
                  <i *ngIf="!message?.isRead" class="fas fa-check"></i>
                </span>
              </div>
            </div>

            <!-- Contenu image -->
            <div
              *ngIf="hasImage(message)"
              class="futuristic-message-image-container"
              [ngClass]="{
                'futuristic-message-pending': message.isPending,
                'futuristic-message-sending':
                  message.isPending && !message.isError,
                'futuristic-message-error': message.isError
              }"
            >
              <div class="futuristic-image-wrapper">
                <a
                  [href]="getImageUrl(message)"
                  target="_blank"
                  class="futuristic-message-image-link"
                >
                  <img
                    [src]="getImageUrl(message)"
                    class="futuristic-message-image"
                    alt="Image"
                  />
                </a>
                <div class="futuristic-image-overlay">
                  <i class="fas fa-expand"></i>
                </div>
              </div>

              <!-- Heure du message avec statut de lecture -->
              <div class="futuristic-message-info">
                <span class="futuristic-message-time">
                  {{ formatMessageTime(message?.timestamp) }}
                </span>
                <span
                  *ngIf="
                    message?.sender?.id === currentUserId ||
                    message?.sender?._id === currentUserId ||
                    message?.senderId === currentUserId
                  "
                  class="futuristic-message-status"
                >
                  <i *ngIf="message?.isRead" class="fas fa-check-double"></i>
                  <i *ngIf="!message?.isRead" class="fas fa-check"></i>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Template pour aucun message -->
    <ng-template #noMessages>
      <div *ngIf="!loading && !error" class="futuristic-no-messages">
        <div class="futuristic-no-messages-icon">
          <i class="fas fa-satellite-dish"></i>
        </div>
        <div class="futuristic-no-messages-text">
          Aucun message dans cette conversation.
          <br />Établissez le premier contact pour commencer.
        </div>
        <button
          (click)="messageForm.get('content')?.setValue('Bonjour!')"
          class="futuristic-start-button"
        >
          <i class="fas fa-paper-plane"></i>
          Initialiser la communication
        </button>
      </div>
    </ng-template>

    <!-- Indicateur de frappe -->
    <div *ngIf="isTyping" class="futuristic-typing-indicator">
      <div class="futuristic-avatar">
        <img
          [src]="otherParticipant?.image || 'assets/images/default-avatar.png'"
          alt="User avatar"
        />
      </div>
      <div class="futuristic-typing-bubble">
        <div class="futuristic-typing-dots">
          <div class="futuristic-typing-dot"></div>
          <div
            class="futuristic-typing-dot"
            style="animation-delay: 0.2s"
          ></div>
          <div
            class="futuristic-typing-dot"
            style="animation-delay: 0.4s"
          ></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Zone de saisie futuriste -->
  <div class="futuristic-input-container">
    <!-- Aperçu du fichier -->
    <div *ngIf="previewUrl" class="futuristic-file-preview">
      <img [src]="previewUrl" class="futuristic-preview-image" />
      <button (click)="removeAttachment()" class="futuristic-remove-button">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <form
      [formGroup]="messageForm"
      (ngSubmit)="sendMessage()"
      class="futuristic-input-form"
    >
      <!-- Boutons d'outils futuristes -->
      <div class="futuristic-input-tools">
        <button type="button" class="futuristic-tool-button">
          <i class="fas fa-plus"></i>
        </button>
        <button
          type="button"
          (click)="fileInput.click()"
          class="futuristic-tool-button"
        >
          <i class="fas fa-image"></i>
          <input
            #fileInput
            type="file"
            (change)="onFileSelected($event)"
            class="hidden"
            accept="image/*"
          />
        </button>
        <button
          type="button"
          (click)="toggleVoiceRecording()"
          class="futuristic-tool-button"
          [ngClass]="{ active: isRecordingVoice }"
        >
          <i
            class="fas"
            [ngClass]="isRecordingVoice ? 'fa-stop' : 'fa-microphone'"
          ></i>
        </button>
        <button type="button" class="futuristic-tool-button">
          <i class="fas fa-sticky-note"></i>
        </button>
      </div>

      <!-- Composant d'enregistrement vocal -->
      <app-voice-recorder
        *ngIf="isRecordingVoice"
        (recordingComplete)="onVoiceRecordingComplete($event)"
        (recordingCancelled)="onVoiceRecordingCancelled()"
        [maxDuration]="60"
      ></app-voice-recorder>

      <input
        formControlName="content"
        type="text"
        placeholder="Saisissez votre message..."
        (input)="onTyping()"
        class="futuristic-input-field"
      />

      <button
        type="submit"
        [disabled]="isUploading || (messageForm.invalid && !selectedFile)"
        class="futuristic-send-button"
      >
        <i *ngIf="!isUploading" class="fas fa-paper-plane"></i>
        <i *ngIf="isUploading" class="fas fa-spinner fa-spin"></i>
      </button>
    </form>
  </div>
</div>
