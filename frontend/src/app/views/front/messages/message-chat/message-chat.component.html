<div class="flex flex-col h-full bg-white chat-container">
  <!-- Chat header (style Messenger) -->
  <div
    class="p-2 border-b border-gray-200 flex items-center sticky top-0 z-10 bg-white message-header"
  >
    <button
      (click)="router.navigate(['../'], { relativeTo: route })"
      class="md:hidden mr-2 p-1 rounded-full hover:bg-gray-100"
    >
      <i class="fas fa-arrow-left text-gray-600"></i>
    </button>

    <div class="flex items-center">
      <div class="relative">
        <img
          [src]="otherParticipant?.image || 'assets/images/default-avatar.png'"
          class="w-8 h-8 rounded-full object-cover"
        />
        <span
          *ngIf="otherParticipant?.isOnline"
          class="absolute bottom-0 right-0 w-2 h-2 bg-green-500 rounded-full border-2 border-white"
        ></span>
      </div>

      <!-- Nom et statut style Messenger -->
      <div *ngIf="otherParticipant" class="flex flex-col ml-2">
        <h2 class="font-medium text-gray-900 text-sm">
          {{ otherParticipant.username }}
        </h2>
        <span class="text-xs text-gray-500">
          {{
            otherParticipant.isOnline
              ? "Active now"
              : formatLastActive(otherParticipant.lastActive)
          }}
        </span>
      </div>
    </div>

    <div class="ml-auto flex space-x-1">
      <button class="p-2 rounded-full hover:bg-gray-100 text-blue-500">
        <i class="fas fa-phone"></i>
      </button>
      <button class="p-2 rounded-full hover:bg-gray-100 text-blue-500">
        <i class="fas fa-video"></i>
      </button>
      <button class="p-2 rounded-full hover:bg-gray-100 text-gray-500">
        <i class="fas fa-info-circle"></i>
      </button>
    </div>
  </div>

  <!-- Messages area -->
  <div
    #messagesContainer
    class="flex-1 overflow-y-auto p-2 space-y-2 message-container"
    (scroll)="onScroll($event)"
  >
    <!-- Loading state (initial) -->
    <div *ngIf="loading" class="flex justify-center items-center h-full">
      <div
        class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-purple-600"
      ></div>
    </div>

    <!-- Loading more messages indicator (style Messenger) -->
    <div
      *ngIf="isLoadingMore"
      class="flex justify-center py-2 sticky top-0 z-10"
    >
      <div
        class="flex flex-col items-center bg-white bg-opacity-80 px-4 py-2 rounded-full shadow-sm"
      >
        <div class="flex space-x-1">
          <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
          <div
            class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"
            style="animation-delay: 0.2s"
          ></div>
          <div
            class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"
            style="animation-delay: 0.4s"
          ></div>
        </div>
      </div>
    </div>

    <!-- No more messages indicator (début de conversation) -->
    <div
      *ngIf="!hasMoreMessages && messages.length > 0"
      class="flex justify-center py-2 mb-2"
    >
      <div class="flex flex-col items-center">
        <div
          class="text-xs text-gray-500 bg-gray-100 px-4 py-2 rounded-full shadow-sm"
        >
          Début de la conversation
        </div>
      </div>
    </div>

    <!-- Error state -->
    <div *ngIf="error" class="p-4 bg-red-50 border-l-4 border-red-500">
      <div class="flex items-start">
        <i class="fas fa-exclamation-circle text-red-500 mt-0.5 mr-2"></i>
        <div>
          <h3 class="text-sm font-medium text-red-800">
            Error loading messages
          </h3>
          <p class="text-sm text-red-700 mt-1">{{ error }}</p>
        </div>
      </div>
    </div>

    <!-- Messages -->
    <ng-container *ngIf="messages && messages.length > 0; else noMessages">
      <div
        *ngFor="let message of messages; let i = index"
        class="flex flex-col"
      >
        <!-- Date separator -->
        <div *ngIf="shouldShowDateHeader(i)" class="message-date-separator">
          {{ formatMessageDate(message?.timestamp) }}
        </div>

        <!-- Message container with alignment -->
        <div
          class="w-full flex"
          [ngClass]="{
            'justify-end':
              message?.sender?.id === currentUserId ||
              message?.sender?._id === currentUserId,
            'justify-start': !(
              message?.sender?.id === currentUserId ||
              message?.sender?._id === currentUserId
            )
          }"
        >
          <!-- RECEIVER MESSAGE (left side) -->
          <ng-container
            *ngIf="
              !(
                message?.sender?.id === currentUserId ||
                message?.sender?._id === currentUserId ||
                message?.senderId === currentUserId
              )
            "
          >
            <div class="flex max-w-[80%] mb-1">
              <!-- Avatar for receiver messages -->
              <div class="flex-shrink-0 mr-1 self-end">
                <img
                  [src]="
                    message?.sender?.image || 'assets/images/default-avatar.png'
                  "
                  class="w-8 h-8 rounded-full object-cover"
                  alt="User avatar"
                  onerror="this.src='assets/images/default-avatar.png'"
                />
              </div>

              <!-- Message content -->
              <div
                [class]="getMessageTypeClass(message)"
                class="shadow-sm message-bubble message-other-user"
              >
                <!-- Text content -->
                <div
                  *ngIf="message?.content"
                  class="text-sm whitespace-normal break-words"
                >
                  {{ message.content }}
                </div>

                <!-- Message time -->
                <div
                  class="text-xs text-right message-time text-gray-500 ml-2 mt-1"
                >
                  {{ formatMessageTime(message?.timestamp) }}
                </div>
              </div>
            </div>
          </ng-container>

          <!-- SENDER MESSAGE (right side) -->
          <ng-container
            *ngIf="
              message?.sender?.id === currentUserId ||
              message?.sender?._id === currentUserId ||
              message?.senderId === currentUserId
            "
          >
            <div class="flex max-w-[80%] mb-1 justify-end">
              <!-- Message content -->
              <div
                [class]="getMessageTypeClass(message)"
                class="shadow-sm message-bubble message-current-user"
              >
                <!-- Text content -->
                <div
                  *ngIf="message?.content"
                  class="text-sm whitespace-normal break-words"
                >
                  {{ message.content }}
                </div>

                <!-- Message time with read status -->
                <div
                  class="text-xs text-right message-time text-white text-opacity-70 flex justify-end items-center mt-1"
                >
                  {{ formatMessageTime(message?.timestamp) }}
                  <span class="ml-1">
                    <i
                      *ngIf="message?.isRead"
                      class="fas fa-check-double text-blue-300"
                    ></i>
                    <i
                      *ngIf="!message?.isRead"
                      class="fas fa-check text-gray-300"
                    ></i>
                  </span>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </ng-container>

    <!-- Template pour aucun message -->
    <ng-template #noMessages>
      <div
        *ngIf="!loading && !error"
        class="flex flex-col items-center justify-center h-64 text-gray-500"
      >
        <i class="fas fa-comments text-4xl mb-4 text-gray-300"></i>
        <p class="text-center">
          Aucun message dans cette conversation. Envoyez un message pour
          commencer!
        </p>
        <button
          (click)="messageForm.get('content')?.setValue('Bonjour!')"
          class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors"
        >
          <i class="fas fa-paper-plane mr-2"></i>
          Envoyer un premier message
        </button>
      </div>
    </ng-template>

    <!-- Typing indicator -->
    <div *ngIf="isTyping" class="flex items-center space-x-2">
      <img
        [src]="otherParticipant?.image || 'assets/images/default-avatar.png'"
        class="w-8 h-8 rounded-full object-cover"
      />
      <div class="bg-gray-100 px-4 py-2 rounded-lg rounded-tl-none">
        <div class="flex space-x-1">
          <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
          <div
            class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
            style="animation-delay: 0.2s"
          ></div>
          <div
            class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
            style="animation-delay: 0.4s"
          ></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Message input (style Messenger) -->
  <div
    class="p-3 border-t border-gray-200 bg-white sticky bottom-0 message-input-container"
  >
    <!-- File preview -->
    <div *ngIf="previewUrl" class="mb-3 relative">
      <img
        [src]="previewUrl"
        class="max-h-40 rounded-lg border border-gray-200"
      />
      <button
        (click)="removeAttachment()"
        class="absolute top-1 right-1 bg-black bg-opacity-50 text-white rounded-full p-1"
      >
        <i class="fas fa-times text-xs"></i>
      </button>
    </div>

    <form
      [formGroup]="messageForm"
      (ngSubmit)="sendMessage()"
      class="flex items-center space-x-3"
    >
      <!-- Boutons d'outils Messenger -->
      <div class="flex space-x-2">
        <button
          type="button"
          class="p-2 text-blue-500 hover:bg-gray-100 rounded-full transition-colors"
        >
          <i class="fas fa-plus"></i>
        </button>
        <button
          type="button"
          (click)="fileInput.click()"
          class="p-2 text-blue-500 hover:bg-gray-100 rounded-full transition-colors"
        >
          <i class="fas fa-image"></i>
          <input
            #fileInput
            type="file"
            (change)="onFileSelected($event)"
            class="hidden"
            accept="image/*, .pdf, .doc, .docx"
          />
        </button>
        <button
          type="button"
          class="p-2 text-blue-500 hover:bg-gray-100 rounded-full transition-colors"
        >
          <i class="fas fa-sticky-note"></i>
        </button>
      </div>

      <input
        formControlName="content"
        type="text"
        placeholder="Message"
        (input)="onTyping()"
        class="flex-1 border border-gray-200 bg-gray-100 rounded-full px-4 py-2 focus:outline-none focus:ring-1 focus:ring-blue-300 focus:border-blue-300 message-input"
      />

      <button
        type="submit"
        [disabled]="isUploading || (messageForm.invalid && !selectedFile)"
        class="p-2 text-blue-500 hover:bg-gray-100 rounded-full disabled:text-blue-300 transition-colors"
      >
        <i *ngIf="!isUploading" class="fas fa-paper-plane"></i>
        <i *ngIf="isUploading" class="fas fa-spinner fa-spin"></i>
      </button>
    </form>
  </div>
</div>
